#!/bin/ksh
####################################################################         
# 
#   backuptab : BCVì—ì„œ Tableì„ ASCii Backupí•˜ëŠ” Shellì…ë‹ˆë‹¤
#
#   ì‘ì„±ì : ë°”ë‹ˆ                 ì‘ì„±ì¼ì : 2003ë…„ 06ì›” 23ì¼
#                                 ìµœì¢…ìˆ˜ì • : 2009ë…„ 06ì›” 10ì¼
#                                 í‘œì¤€ë²„ì „ : v0.2
#
#   ì‚¬ìš©ë²• : backuptab (í˜„ì¬ì¼ì ì´ì „ ëª‡ì¼)
#   ìš”íŒŒì¼ : [m01/m02]:/informix/SCHEMA/tables_[d/m]_bak_[1/p]_[ë³´ê´€ê¸°ê°„]
#   ê²°ê³¼ë¬¼ : tables_x.yyyymmdd (optional)
#   ì£¼  ì˜ : Text Columnì´ í¬í•¨ëœ Tableì€ Backupì´ ì•ˆë  ìˆ˜ë„ ìˆìŒ
#
####################################################################

# Tool í´ë” ì„¤ì • ########################################################
if [ ! "$TOOL" ]
then export TOOL=$HOME/tool
fi
#########################################################################


# OSë³„ awk ì„¤ì • #########################################################
if [ `uname` = 'HP-UX' ]
then
   export CAWK=awk
else
   export CAWK=nawk
fi
#########################################################################


# ì„ì‹œíŒŒì¼ ì´ˆê¸°í™” #######################################################
export TempTail=`tty | $CAWK -F/ '{print $4}'`
export TempFile1=$TOOL/tmp/`echo $0 | $CAWK -F '/' '{ print $NF }'`.tmp_${TempTail}
export TempFile2=$TOOL/tmp/`echo $0 | $CAWK -F '/' '{ print $NF }'`.tmp2_${TempTail}
export TempFile3=$TOOL/tmp/`echo $0 | $CAWK -F '/' '{ print $NF }'`.tmp3_${TempTail}
export TempFile4=$TOOL/tmp/`echo $0 | $CAWK -F '/' '{ print $NF }'`.tmp4_${TempTail}

if [ -f $TempFile1 ]; then rm $TempFile1; fi
if [ -f $TempFile2 ]; then rm $TempFile2; fi
if [ -f $TempFile3 ]; then rm $TempFile3; fi
if [ -f $TempFile4 ]; then rm $TempFile4; fi
#########################################################################


# DBëª… ì„¤ì • #############################################################
if [ ! "$2" ]
then
	if [ ! "$DBNAME" ]
	then export dbname="dbname"
	else export dbname=$DBNAME
	fi
else export dbname=$2
fi
#########################################################################

echo '[0m\c'
################### Default #############################################


if [ ! "$1" ]
then export minus=0
else export minus=$1
fi

while true
do ##### Main While Loop

cd /backlog/informix

###########################################
#   ì •ë³´ê³„
###########################################

if [ $INFORMIXSERVER = 'mst02_tcp' ] || [ $INFORMIXSERVER = 'tst2_tcp' ]
then 

	export server='m02'
	export dbserver='mst02_tcp'

	echo
	echo '-------------------------------------------'
	echo '     ë°±ì—…í•  í…Œì´ë¸”ì˜ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”'
	echo '-------------------------------------------'
	echo '     1) ì¼ ì£¼ê¸° í…Œì´ë¸”'
	echo '     2) ì›” ì£¼ê¸° í…Œì´ë¸”'
	echo '     0) ë¹ ì ¸ ë‚˜ê°€ê¸°'
	echo '-------------------------------------------'
	echo '     > \c'
	read yn
	echo

	if [ $yn -eq 1 ]; then 
	
		echo
		echo '-------------------------------------------'
		echo '     ë°±ì—…í•  í…Œì´ë¸”ì˜ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”'
		echo '-------------------------------------------'
		echo '     1) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´   7ì¼) í…Œì´ë¸”'
		echo '     2) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´  31ì¼) í…Œì´ë¸”'
		echo '     3) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´  62ì¼) í…Œì´ë¸”'
		echo '     4) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´ 184ì¼) í…Œì´ë¸”'
		echo '-------------------------------------------'
		echo '     > \c'
		read yn
		echo
	
		if [ $yn -eq 1 ]; then 
			export term='d'
			export save='p'
			export day='7'
			cd $server/day/$save
		elif [ $yn -eq 2 ]; then
			export term='d'
			export save='p'
			export day='31'
			cd $server/day/$save
		elif [ $yn -eq 3 ]; then
			export term='d'
			export save='p'
			export day='62'
			cd $server/day/$save
		elif [ $yn -eq 4 ]; then
			export term='d'
			export save='p'
			export day='184'
			cd $server/day/$save
		else
			echo 'ì…ë ¥ ì˜¤ë¥˜ ì…ë‹ˆë‹¤'
			exit
		fi

dbaccess $DBNAME <<! 1> /dev/null 2> /dev/null
set isolation to dirty read;
unload to $TempFile1 delimiter ' '
select first 1 to_char( today - $minus -1 - $day, "%Y%m%d" ) tabdate from dual;
!

		echo '1,$s/ //g\nw\nq' | ed $TempFile1 > /dev/null
		export theday=`cat $TempFile1`
		if [ -f $TempFile1 ]; then rm $TempFile1; fi

dbaccess $DBNAME <<! 1> /dev/null 2> /dev/null
set isolation to dirty read;
unload to $TempFile1 delimiter ' '
select to_char( today - $minus -1 -$day, "%Y%m%d" ) tabdate from dual
union all
select to_char( today - $minus -2 -$day, "%Y%m%d" ) tabdate from dual
union all
select to_char( today - $minus -3 -$day, "%Y%m%d" ) tabdate from dual
union all
select to_char( today - $minus -4 -$day, "%Y%m%d" ) tabdate from dual
union all
select to_char( today - $minus -5 -$day, "%Y%m%d" ) tabdate from dual
union all
select to_char( today - $minus -6 -$day, "%Y%m%d" ) tabdate from dual
union all
select to_char( today - $minus -7 -$day, "%Y%m%d" ) tabdate from dual;
!

		export tables=`echo 'tables_'$term'_bak_'$save'_'$day`
		rcp `echo ${server}':/informix/SCHEMA/tables_'$term'_bak_'$save'_'$day` .
	
		echo
		echo '-------------------------------------------'
		for i in `cat $tables`
		do
			echo $i$theday
		done
		echo '-------------------------------------------'
		cat $TempFile1
		echo '-------------------------------------------'
		echo 'ì´ í…Œì´ë¸”ë“¤ì„ backup í•˜ë©´ ë˜ê² ìŠµë‹ˆê¹Œ? \c'
		read yn
		if [ $yn = 'y' ]
		then
	
			for i in `cat $tables`
			do
				if [ -f $TempFile2 ]; then rm $TempFile2; fi
	
				if [ -d $i ]
				then echo 'ê¸°ì¡´ì˜ '$i' ë””ë ‰í† ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.'
				else mkdir $i; echo $i' ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“­ë‹ˆë‹¤.'
				fi
	
				if [ -d $i/$i$theday ]
				then echo 'ê¸°ì¡´ì˜ '$i$theday' ë””ë ‰í† ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.'
				else mkdir $i/$i$theday; echo $i$theday' ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“­ë‹ˆë‹¤.'
				fi
	
				for j in `cat $TempFile1`
				do
					echo $i$j >> $TempFile2
				done 
	
				count $TempFile2 | grep -v '^$' | grep -v 'ì—†ìŒ' > ${i}_${theday}.cnt
				cd $i/$i$theday
				for k in `cat $TempFile2`
				do
					if [ -f $TempFile3 ]; then rm $TempFile3; fi
					if [ -f $TempFile4 ]; then rm $TempFile4; fi

# ì¹´ë“œë²ˆí˜¸ ì‚­ì œ í•„ìš” í…Œì´ë¸” Check í›„ Unload ì‹œì‘

					export cardtable='none'
					export cardcolumn='none'
               rcp m02:/informix/SCHEMA/tables_d_card .
               for ct in `cat tables_d_card | $CAWK -F ' ' '{print $1}'`
					do
						if [ $i = $ct ]; then
							export cardtable=$i
							export cardcolumn1=`grep ^$ct tables_d_card | $CAWK -F ' ' '{print $2}'`
							export column1len=`grep ^$ct tables_d_card | $CAWK -F ' ' '{print $3}'`
							export cardcolumn2=`grep ^$ct tables_d_card | $CAWK -F ' ' '{print $4}'`
							export column2len=`grep ^$ct tables_d_card | $CAWK -F ' ' '{print $5}'`
							export cardcolumn3=`grep ^$ct tables_d_card | $CAWK -F ' ' '{print $6}'`
							export column3len=`grep ^$ct tables_d_card | $CAWK -F ' ' '{print $7}'`
						fi
					done

					if [ $cardtable = 'none' ]; then
# ì¼ë°˜ Table Unload ì‹œì‘
						unload $k 1> /dev/null 2> $TempFile3
# ì¼ë°˜ Table Unload ì™„ë£Œ
					else
						dbaccess $DBNAME <<! 1> /dev/null 2> /dev/null
							unload to $TempFile4
							select c.colno, c.colname
							  from syscolumns c, systables t
							 where t.tabname = '$k'
							   and t.tabid = c.tabid
							 order by 1;
!
						export sql='unload to '$k'.unl select '
						export NumberOfCol=`cat $TempFile4 | wc -l`
						for columns in `cat $TempFile4`
						do
							export colno=`echo $columns | $CAWK -F '|' '{print $1}'`
							export colname=`echo $columns | $CAWK -F '|' '{print $2}'`
							export sql=$sql$colname
							if [ $colname = $cardcolumn1 ]; then
								export sql=$sql'[1,8] || "xxxx" || '$colname'[13,'$column1len']'
							elif [ x$colname = x$cardcolumn2 ]; then
								export sql=$sql'[1,8] || "xxxx" || '$colname'[13,'$column2len']'
							elif [ x$colname = x$cardcolumn3 ]; then
								export sql=$sql'[1,8] || "xxxx" || '$colname'[13,'$column3len']'
							fi
							if [ $colno -lt $NumberOfCol ]; then 
								export sql=$sql','
							fi
						done
						export sql=$sql' from '$k
						echo 'Card No 3rd Range Deleted\c'
						dbaccess $DBNAME <<! 1> /dev/null 2> $TempFile3
							$sql
!
						if [ -f $TempFile4 ]; then rm $TempFile4; fi
						echo $k >> /backlog/informix/work/tables_x.m02_`date +"%Y%m%d"`
					fi

					rm tables_d_card

# ì¹´ë“œë²ˆí˜¸ ì‚­ì œ í•„ìš” í…Œì´ë¸” Check í›„ Unload ì™„ë£Œ

					cat $TempFile3 | $CAWK -F ' ' '{
						{ if ( $3 == "unloaded." ) printf("%30s :%10d\n", "'$k'", $1); }
					}' > $TempFile4
					cat $TempFile4
					cat $TempFile4 >> ../../${i}_${theday}.bak
					rsh m02 /informix/tool/sossch $k > $k.sql
				done
				cd ../..
			done

			rm $tables
	
		else
	
			echo 'ì·¨ì†Œ ë˜ì—ˆìŠµë‹ˆë‹¤.'
	
		fi

	elif [ $yn -eq 2 ]; then 

		echo
		echo '-------------------------------------------'
		echo '     ë°±ì—…í•  í…Œì´ë¸”ì˜ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”'
		echo '-------------------------------------------'
		echo '     1) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´ 6ê°œì›”) í…Œì´ë¸”'
		echo '     2) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´   1ë…„) í…Œì´ë¸”'
		echo '     3) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´   2ë…„) í…Œì´ë¸”'
		echo '     4) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´   2ë…„) ë§ˆì´ì¥ë¶€'
		echo '     5) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´   3ë…„) í…Œì´ë¸”'
		echo '     6) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´   5ë…„) í…Œì´ë¸”'
		echo '-------------------------------------------'
		echo '     > \c'
		read yn
		echo
	
		if [ $yn -eq 1 ]; then 
			export term='m'
			export save='p'
			export month='6'
			cd $server/month/$save
		elif [ $yn -eq 2 ]; then
			export term='m'
			export save='p'
			export month='12'
			cd $server/month/$save
		elif [ $yn -eq 3 ]; then
			export term='m'
			export save='p'
			export month='24'
			cd $server/month/$save
		elif [ $yn -eq 4 ]; then
			export term='m'
			export save='p'
			export month='24'
			cd $server/month/$save
			export server='henry'
			export dbserver='henry_tcp'
		elif [ $yn -eq 5 ]; then
			export term='m'
			export save='p'
			export month='36'
			cd $server/month/$save
		elif [ $yn -eq 6 ]; then
			export term='m'
			export save='p'
			export month='60'
			cd $server/month/$save
		else
			echo 'ì…ë ¥ ì˜¤ë¥˜ ì…ë‹ˆë‹¤'
			exit
		fi

dbaccess $DBNAME <<! 1> /dev/null 2> /dev/null
set isolation to dirty read;
unload to $TempFile1 delimiter ' '
select first 1 to_char( today - interval(`expr $month + $minus + 1`) month to month, "%Y%m" ) tabdate from dual;
!

		echo '1,$s/ //g\nw\nq' | ed $TempFile1 > /dev/null
		export themonth=`cat $TempFile1`
		if [ -f $TempFile1 ]; then rm $TempFile1; fi

		export tables=`echo 'tables_'$term'_bak_'$save'_'$month`
		
		if [ $server = 'm02' ]
		then rcp `echo ${server}':/informix/SCHEMA/tables_'$term'_bak_'$save'_'$month` .
#######################################################################################
#     ë§ˆì´ì¥ë¶€ ì´ê´€ì´ ëë‚˜ë©´ ì•„ë˜ ë¼ì¸ì„ ìˆ˜ì •í•˜ë¼.
		else rcp `echo 'm03:/informix/SCHEMA/M03/tables_'$term'_bak_'$save'_'$month` .
#######################################################################################
		fi
	
		echo
		echo '-------------------------------------------'
		for i in `cat $tables`
		do
			echo $i$themonth
		done
		echo '-------------------------------------------'
		echo $themonth
		echo '-------------------------------------------'
		echo 'ì´ í…Œì´ë¸”ë“¤ì„ backup í•˜ë©´ ë˜ê² ìŠµë‹ˆê¹Œ? \c'
		read yn
		if [ $yn = 'y' ]
		then
	
			for i in `cat $tables`
			do
	
				if [ -d $i ]
				then echo 'ê¸°ì¡´ì˜ '$i' ë””ë ‰í† ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.'
				else mkdir $i; echo $i' ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“­ë‹ˆë‹¤.'
				fi
	
				count $i$themonth ${DBNAME}@${dbserver} | grep -v '^$' | grep -v 'ì—†ìŒ' > ${i}_${themonth}.cnt
				cd $i

				if [ -f $TempFile3 ]; then rm $TempFile3; fi
				if [ -f $TempFile4 ]; then rm $TempFile4; fi
				unload $i$themonth ${DBNAME}@${dbserver} 1> /dev/null 2> $TempFile3
				cat $TempFile3 | $CAWK -F ' ' '{
					{ if ( $3 == "unloaded." ) printf("%30s :%10d\n", "'$i$themonth'", $1); }
				}' > $TempFile4
				cat $TempFile4
				cat $TempFile4 >> ../${i}_${themonth}.bak
				rsh $server /informix/tool/sossch $i$themonth > $i$themonth.sql

				cd ..
			done
	
		else
	
			echo 'ì·¨ì†Œ ë˜ì—ˆìŠµë‹ˆë‹¤.'
	
		fi
		
		rm $tables

	elif [ $yn -eq 0 ]; then 

		echo
		echo 'ë¹ ì´ë¹ ì´'
		exit

	else

		echo
		echo 'ì˜ëª» ì…ë ¥ í•˜ì…¨ìŠµë‹ˆë‹¤.'
		exit

	fi
	

###########################################
#   ì—…ë¬´ê³„
###########################################

elif [ $INFORMIXSERVER = 'mst01_tcp' ] || [ $INFORMIXSERVER = 'tst_tcp' ]; then

	export server='m01'

	echo
	echo '-------------------------------------------'
	echo '     ë°±ì—…í•  í…Œì´ë¸”ì˜ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”'
	echo '-------------------------------------------'
	echo '     1) ì¼ ì£¼ê¸° í…Œì´ë¸”'
	echo '     2) ì›” ì£¼ê¸° í…Œì´ë¸”'
	echo '     0) ë¹ ì ¸ ë‚˜ê°€ê¸°'
	echo '-------------------------------------------'
	echo '     > \c'
	read yn
	echo

	if [ $yn -eq 1 ]; then 
	
		echo
		echo '-------------------------------------------'
		echo '     ë°±ì—…í•  í…Œì´ë¸”ì˜ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”'
		echo '-------------------------------------------'
		echo '     1) 1 ë…„ë³´ê´€ (ì„œë²„ë³´ì¡´  31ì¼) í…Œì´ë¸”'
		echo '     2) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´  31ì¼) í…Œì´ë¸”'
		echo '     3) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´  92ì¼) í…Œì´ë¸”'
		echo '     4) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´ 366ì¼) í…Œì´ë¸”'
		echo '-------------------------------------------'
		echo '     > \c'
		read yn
		echo
	
		if [ $yn -eq 1 ]; then 
			export term='d'
			export save='1'
			export day='31'
			cd $server/day/$save
		elif [ $yn -eq 2 ]; then
			export term='d'
			export save='p'
			export day='31'
			cd $server/day/$save
		elif [ $yn -eq 3 ]; then
			export term='d'
			export save='p'
			export day='92'
			cd $server/day/$save
		elif [ $yn -eq 4 ]; then
			export term='d'
			export save='p'
			export day='366'
			cd $server/day/$save
		else
			echo 'ì…ë ¥ ì˜¤ë¥˜ ì…ë‹ˆë‹¤'
			exit
		fi

dbaccess $DBNAME <<! 1> /dev/null 2> /dev/null
set isolation to dirty read;
unload to $TempFile1 delimiter ' '
select first 1 to_char( today - $minus -1 - $day, "%Y%m%d" ) tabdate from dual;
!
echo '1,$s/ //g\nw\nq' | ed $TempFile1 > /dev/null
export theday=`cat $TempFile1`
if [ -f $TempFile1 ]; then rm $TempFile1; fi

dbaccess $DBNAME <<! 1> /dev/null 2> /dev/null
set isolation to dirty read;
unload to $TempFile1 delimiter ' '
select to_char( today - $minus -1 -$day, "%y%m%d" ) tabdate from dual
union all
select to_char( today - $minus -2 -$day, "%y%m%d" ) tabdate from dual
union all
select to_char( today - $minus -3 -$day, "%y%m%d" ) tabdate from dual
union all
select to_char( today - $minus -4 -$day, "%y%m%d" ) tabdate from dual
union all
select to_char( today - $minus -5 -$day, "%y%m%d" ) tabdate from dual
union all
select to_char( today - $minus -6 -$day, "%y%m%d" ) tabdate from dual
union all
select to_char( today - $minus -7 -$day, "%y%m%d" ) tabdate from dual;
!
	
		export tables=`echo 'tables_'$term'_bak_'$save'_'$day`
		rcp `echo ${server}':/informix/SCHEMA/tables_'$term'_bak_'$save'_'$day` .
	
		echo
		echo '-------------------------------------------'
		for i in `cat $tables`
		do
			echo $i$theday
		done
		echo '-------------------------------------------'
		cat $TempFile1
		echo '-------------------------------------------'
		echo 'ì´ í…Œì´ë¸”ë“¤ì„ backup í•˜ë©´ ë˜ê² ìŠµë‹ˆê¹Œ? \c'
		read yn
		if [ $yn = 'y' ]
		then
	
			for i in `cat $tables`
			do
				if [ -f $TempFile2 ]; then rm $TempFile2; fi
	
				if [ -d $i ]
				then echo 'ê¸°ì¡´ì˜ '$i' ë””ë ‰í† ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.'
				else mkdir $i; echo $i' ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“­ë‹ˆë‹¤.'
				fi
	
				if [ -d $i/$i$theday ]
				then echo 'ê¸°ì¡´ì˜ '$i$theday' ë””ë ‰í† ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.'
				else mkdir $i/$i$theday; echo $i$theday' ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“­ë‹ˆë‹¤.'
				fi
	
				for j in `cat $TempFile1`
				do
					echo $i$j >> $TempFile2
				done 
	
				count $TempFile2 | grep -v '^$' | grep -v 'ì—†ìŒ' > ${i}_${theday}.cnt
				cd $i/$i$theday
				for k in `cat $TempFile2`
				do
					if [ -f $TempFile3 ]; then rm $TempFile3; fi
					if [ -f $TempFile4 ]; then rm $TempFile4; fi

# ì¹´ë“œë²ˆí˜¸ ì‚­ì œ í•„ìš” í…Œì´ë¸” Check í›„ Unload ì‹œì‘

					export cardtable='none'
					export cardcolumn='none'
               rcp m01:/informix/SCHEMA/tables_d_card .
               for ct in `cat tables_d_card | $CAWK -F ' ' '{print $1}'`
					do
						if [ $i = $ct ]; then
							export cardtable=$i
							export cardcolumn1=`grep ^$ct tables_d_card | $CAWK -F ' ' '{print $2}'`
							export column1len=`grep ^$ct tables_d_card | $CAWK -F ' ' '{print $3}'`
							export cardcolumn2=`grep ^$ct tables_d_card | $CAWK -F ' ' '{print $4}'`
							export column2len=`grep ^$ct tables_d_card | $CAWK -F ' ' '{print $5}'`
							export cardcolumn3=`grep ^$ct tables_d_card | $CAWK -F ' ' '{print $6}'`
							export column3len=`grep ^$ct tables_d_card | $CAWK -F ' ' '{print $7}'`
						fi
					done

					if [ $cardtable = 'none' ]; then
# ì¼ë°˜ Table Unload ì‹œì‘
						unload $k 1> /dev/null 2> $TempFile3
# ì¼ë°˜ Table Unload ì™„ë£Œ
					else
						dbaccess $DBNAME <<! 1> /dev/null 2> /dev/null
							unload to $TempFile4
							select c.colno, c.colname
							  from syscolumns c, systables t
							 where t.tabname = '$k'
							   and t.tabid = c.tabid
							 order by 1;
!
						export sql='unload to '$k'.unl select '
						export NumberOfCol=`cat $TempFile4 | wc -l`
						for columns in `cat $TempFile4`
						do
							export colno=`echo $columns | $CAWK -F '|' '{print $1}'`
							export colname=`echo $columns | $CAWK -F '|' '{print $2}'`
							export sql=$sql$colname
							if [ $colname = $cardcolumn1 ]; then
								export sql=$sql'[1,8] || "xxxx" || '$colname'[13,'$column1len']'
							elif [ x$colname = x$cardcolumn2 ]; then
								export sql=$sql'[1,8] || "xxxx" || '$colname'[13,'$column2len']'
							elif [ x$colname = x$cardcolumn3 ]; then
								export sql=$sql'[1,8] || "xxxx" || '$colname'[13,'$column3len']'
							fi
							if [ $colno -lt $NumberOfCol ]; then 
								export sql=$sql','
							fi
						done
						export sql=$sql' from '$k
						echo 'Card No 3rd Range Deleted\c'
						dbaccess $DBNAME <<! 1> /dev/null 2> $TempFile3
							$sql
!
						if [ -f $TempFile4 ]; then rm $TempFile4; fi
						echo $k >> /backlog/informix/work/tables_x.`date +"%Y%m%d"`
					fi

					rm tables_d_card

# ì¹´ë“œë²ˆí˜¸ ì‚­ì œ í•„ìš” í…Œì´ë¸” Check í›„ Unload ì™„ë£Œ

					cat $TempFile3 | $CAWK -F ' ' '{
						{ if ( $3 == "unloaded." ) printf("%30s :%10d\n", "'$k'", $1); }
					}' > $TempFile4
					cat $TempFile4
					cat $TempFile4 >> ../../${i}_${theday}.bak
					rsh m01 /informix/tool/sossch $k > $k.sql
				done
				cd ../..
			done

			rm $tables
	
		else
	
			echo 'ì·¨ì†Œ ë˜ì—ˆìŠµë‹ˆë‹¤.'
	
		fi

	elif [ $yn -eq 2 ]; then 

		echo
		echo '-------------------------------------------'
		echo '     ë°±ì—…í•  í…Œì´ë¸”ì˜ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”'
		echo '-------------------------------------------'
		echo '     1) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´ 2ê°œì›”) í…Œì´ë¸” (í˜„ì¬ì—†ìŒ)'
		echo '     2) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´ 3ê°œì›”) í…Œì´ë¸”'
		echo '     3) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´ 6ê°œì›”) í…Œì´ë¸”'
		echo '     4) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´ 1ë…„) í…Œì´ë¸”'
		echo '-------------------------------------------'
		echo '     > \c'
		read yn
		echo
	
		if [ $yn -eq 1 ]; then 
			export term='m'
			export save='p'
			export month='2'
			cd $server/month/$save
		elif [ $yn -eq 2 ]; then 
			export term='m'
			export save='p'
			export month='3'
			cd $server/month/$save
		elif [ $yn -eq 3 ]; then
			export term='m'
			export save='p'
			export month='6'
			cd $server/month/$save
		elif [ $yn -eq 4 ]; then
			export term='m'
			export save='p'
			export month='12'
			cd $server/month/$save
		else
			echo 'ì…ë ¥ ì˜¤ë¥˜ ì…ë‹ˆë‹¤'
			exit
		fi

dbaccess $DBNAME <<! 1> /dev/null 2> /dev/null
set isolation to dirty read;
unload to $TempFile1 delimiter ' '
select first 1 to_char( today - interval(`expr $month + $minus + 1`) month to month, "%y%m" ) tabdate from dual;
!

		echo '1,$s/ //g\nw\nq' | ed $TempFile1 > /dev/null
		export themonth=`cat $TempFile1`
		if [ -f $TempFile1 ]; then rm $TempFile1; fi

		export tables=`echo 'tables_'$term'_bak_'$save'_'$month`
		rcp `echo ${server}':/informix/SCHEMA/tables_'$term'_bak_'$save'_'$month` .
	
		echo
		echo '-------------------------------------------'
		for i in `cat $tables`
		do
			echo $i$themonth
		done
		echo '-------------------------------------------'
		echo $themonth
		echo '-------------------------------------------'
		echo 'ì´ í…Œì´ë¸”ë“¤ì„ backup í•˜ë©´ ë˜ê² ìŠµë‹ˆê¹Œ? \c'
		read yn
		if [ $yn = 'y' ]
		then
	
			for i in `cat $tables`
			do
	
				if [ -d $i ]
				then echo 'ê¸°ì¡´ì˜ '$i' ë””ë ‰í† ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.'
				else mkdir $i; echo $i' ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“­ë‹ˆë‹¤.'
				fi
	
				count $i$themonth | grep -v '^$' | grep -v 'ì—†ìŒ' > ${i}_${themonth}.cnt
				cd $i

				if [ -f $TempFile3 ]; then rm $TempFile3; fi
				if [ -f $TempFile4 ]; then rm $TempFile4; fi
				unload $i$themonth 1> /dev/null 2> $TempFile3
				cat $TempFile3 | $CAWK -F ' ' '{
					{ if ( $3 == "unloaded." ) printf("%30s :%10d\n", "'$i$themonth'", $1); }
				}' > $TempFile4
				cat $TempFile4
				cat $TempFile4 >> ../${i}_${themonth}.bak
				rsh m01 /informix/tool/sossch $i$themonth > $i$themonth.sql

				cd ..
			done

			rm $tables
	
		else
	
			echo 'ì·¨ì†Œ ë˜ì—ˆìŠµë‹ˆë‹¤.'
	
		fi

	elif [ $yn -eq 0 ]; then 

		echo
		echo 'ë¹ ì´ë¹ ì´'
		exit

	else

		echo
		echo 'ì˜ëª» ì…ë ¥ í•˜ì…¨ìŠµë‹ˆë‹¤.'
		exit

	fi

###########################################
#   ì‹  ë§ˆì´ì¥ë¶€
###########################################

elif [ $INFORMIXSERVER = 'henry_tcp' ]; then

	export server='henry'

	echo
	echo '-------------------------------------------'
	echo '     ë°±ì—…í•  í…Œì´ë¸”ì˜ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”'
	echo '-------------------------------------------'
	echo '     2) ì›” ì£¼ê¸° í…Œì´ë¸”'
	echo '     0) ë¹ ì ¸ ë‚˜ê°€ê¸°'
	echo '-------------------------------------------'
	echo '     > \c'
	read yn
	echo

	if [ $yn -eq 2 ]; then 

		echo
		echo '-------------------------------------------'
		echo '     ë°±ì—…í•  í…Œì´ë¸”ì˜ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”'
		echo '-------------------------------------------'
		echo '     1) ì˜êµ¬ë³´ê´€ (ì„œë²„ë³´ì¡´ 1ë…„) í…Œì´ë¸”'
		echo '-------------------------------------------'
		echo '     > \c'
		read yn
		echo
	
		if [ $yn -eq 1 ]; then 
			export term='m'
			export save='p'
			export month='12'
			cd $server/month/$save
		else
			echo 'ì…ë ¥ ì˜¤ë¥˜ ì…ë‹ˆë‹¤'
			exit
		fi

		dbaccess $DBNAME <<! 1> /dev/null 2> /dev/null
			set isolation to dirty read;
			unload to $TempFile1 delimiter ' '
			select first 1 to_char( today - interval(`expr $month + $minus + 1`) month to month, "%y%m" ) tabdate from dual;
!

		echo '1,$s/ //g\nw\nq' | ed $TempFile1 > /dev/null
		export themonth=`cat $TempFile1`
		if [ -f $TempFile1 ]; then rm $TempFile1; fi

		export tables=`echo 'tables_'$term'_bak_'$save'_'$month`
		rcp `echo ${server}':/informix/SCHEMA/tables_'$term'_bak_'$save'_'$month` .
	
		echo
		echo '-------------------------------------------'
		for i in `cat $tables`
		do
			echo $i$themonth
		done
		echo '-------------------------------------------'
		echo $themonth
		echo '-------------------------------------------'
		echo 'ì´ í…Œì´ë¸”ë“¤ì„ backup í•˜ë©´ ë˜ê² ìŠµë‹ˆê¹Œ? \c'
		read yn
		if [ $yn = 'y' ]
		then
	
			for i in `cat $tables`
			do
	
				if [ -d $i ]
				then echo 'ê¸°ì¡´ì˜ '$i' ë””ë ‰í† ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.'
				else mkdir $i; echo $i' ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“­ë‹ˆë‹¤.'
				fi
	
				count $i$themonth | grep -v '^$' | grep -v 'ì—†ìŒ' > ${i}_${themonth}.cnt
				cd $i

				if [ -f $TempFile3 ]; then rm $TempFile3; fi
				if [ -f $TempFile4 ]; then rm $TempFile4; fi
				unload $i$themonth 1> /dev/null 2> $TempFile3
				cat $TempFile3 | $CAWK -F ' ' '{
					{ if ( $3 == "unloaded." ) printf("%30s :%10d\n", "'$i$themonth'", $1); }
				}' > $TempFile4
				cat $TempFile4
				cat $TempFile4 >> ../${i}_${themonth}.bak
				ds /informix/tool/sossch $i$themonth > $i$themonth.sql

				cd ..
			done

			rm $tables
	
		else
	
			echo 'ì·¨ì†Œ ë˜ì—ˆìŠµë‹ˆë‹¤.'
	
		fi

	elif [ $yn -eq 0 ]; then 

		echo
		echo 'ë¹ ì´ë¹ ì´'
		exit

	else

		echo
		echo 'ì˜ëª» ì…ë ¥ í•˜ì…¨ìŠµë‹ˆë‹¤.'
		exit

	fi

else

	echo 'í™˜ê²½ ì„¤ì •ì„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš” ^^'

fi

if [ -f $TempFile1 ]; then rm $TempFile1; fi
if [ -f $TempFile2 ]; then rm $TempFile2; fi
if [ -f $TempFile3 ]; then rm $TempFile3; fi
if [ -f $TempFile4 ]; then rm $TempFile4; fi

done ##### Main While Loop
