#!/bin/ksh

#########################################################################         
# 
#   chkchk : Chunkì˜ ì „ì²´ê³µê°„ê³¼ ì—¬ìœ ê³µê°„ì„ ë³´ì—¬ì£¼ëŠ” Shellì…ë‹ˆë‹¤
#                                 í‘œì¤€ë²„ì „ : v0.1
#   ì‚¬ìš©ë²• : chkchk
#   ìš”íŒŒì¼ : $INFORMIXDIR/tool/etc/${INFORMIXSERVER}_chk.cnf 
#            ( Chunk Limit ì„¤ì • íŒŒì¼ )
#
#########################################################################

# Tool í´ë” ì„¤ì • ########################################################
if [ ! "$TOOL" ]
then export TOOL=$HOME/tool
fi
#########################################################################


# OSë³„ awk ì„¤ì • #########################################################
if [ `uname` = 'HP-UX' ]
then
   export CAWK=awk
else
   export CAWK=nawk
fi
#########################################################################


# Pagesize í™•ì¸ #########################################################
export pagesize=`onstat -b | grep 'buffer size' | $CAWK -F 'buffer size' '
                                                     { print $1 }
                                                  ' | $CAWK -F ' ' '
                                                          { print $NF }
                                                       '`
export pagesize=`expr $pagesize / 1024`
#########################################################################


# ì„ì‹œíŒŒì¼ ì´ˆê¸°í™” #######################################################
export TempTail=`tty | $CAWK -F/ '{print $4}'`
export TempFile1=$TOOL/tmp/`echo $0 | $CAWK -F '/' '{ print $NF }'`.tmp_${TempTail}
export TempFile2=$TOOL/tmp/`echo $0 | $CAWK -F '/' '{ print $NF }'`.tmp2_${TempTail}
export TempFile3=$TOOL/tmp/`echo $0 | $CAWK -F '/' '{ print $NF }'`.tmp3_${TempTail}

if [ -f $TempFile1 ]; then rm $TempFile1; fi
if [ -f $TempFile2 ]; then rm $TempFile2; fi
if [ -f $TempFile3 ]; then rm $TempFile3; fi
#########################################################################

echo '[0m\c'
################### Default #############################################

dbaccess sysmaster<<! 1> /dev/null 2> /dev/null
	set isolation to dirty read;
	unload to $TempFile1 delimiter ' '
	select d.name, sum(c.chksize), sum(c.nfree) 
	  from sysdbspaces d, syschktab c
	 where d.dbsnum = c.dbsnum
	 group by d.name
	 order by d.name;
!

if [ -f $INFORMIXDIR/tool/etc/${INFORMIXSERVER}_chk.cnf ]
then

	for i in `cat $INFORMIXDIR/tool/etc/${INFORMIXSERVER}_chk.cnf`
	do
		echo 'o\c'
	
		dbspace=`echo $i | $CAWK -F '|' '{ print $1 }'`
		limit=`echo $i | $CAWK -F '|' '{ print $2 }'`
		fullfree=`echo $i | $CAWK -F '|' '{ print $3 }'`
	
		dbaccess sysmaster<<! 1> /dev/null 2> /dev/null
			set isolation to dirty read;
			unload to $TempFile3 delimiter ' '
			select d.name, sum(nvl(c.nfree,0)) free, count(c.nfree) fchks, 
                $limit limit, $fullfree fullfree
			  from sysdbspaces d, outer syschktab c
			 where d.dbsnum = c.dbsnum
			   and d.name = '$dbspace'
			   and nfree > `expr $fullfree / $pagesize`
			 group by d.name
			 order by d.name;
!

	cat $TempFile3 >> $TempFile2
	done

fi

# Chunkì˜ ì „ì²´ ê³µê°„ê³¼ ì—¬ìœ  ê³µê°„ í‘œì‹œ
echo 
echo '-------------------------------------------------------'
echo '[43;36mdbspace name        chunk total size    chunk free size[0m'
echo '-------------------------------------------------------'
cat $TempFile1 | $CAWK -F ' ' '
{
  	chksize=prtnum($2*'$pagesize');
  	freesize=prtnum($3*'$pagesize');

  	if ( $1 == "indexdbs" ) 
     	printf("[4m%-19s %16s   %16s[0m\n", $1, chksize, freesize);
  	else
     	printf("%-19s %16s   %16s\n", $1, chksize, freesize);
}
function prtnum ( num ) {
   result="";
	orgnum=num;
   while ( int(num / 1000 * 1000) > 0 )
   {
      temp=result;
      if ( num - int(num / 1000) * 1000 == 0 && int(num / 1000) > 0)
         result="000";
      else if ( num - int(num / 1000) * 1000 < 10 && int(num / 1000) > 0)
         result="00"(num - int(num / 1000) * 1000);
      else if ( num - int(num / 1000) * 1000 < 100 && int(num / 1000) > 0)
         result="0"(num - int(num / 1000) * 1000);
      else result=(num - int(num / 1000) * 1000);

      if ( num != orgnum ) result = result","temp;
      num = int(num / 1000);
   }
   if ( result == "" ) result=0;

	return result
}
'

echo '-------------------------------------------------------'

# 2G ì´ìƒ ê³µê°„ì´ ë‚¨ì€ Chunk ê°¯ìˆ˜
if [ -f $INFORMIXDIR/tool/etc/${INFORMIXSERVER}_chk.cnf ]
then 

	echo '[43;36mdbspace name             free chunks    free chunk size[0m'
	echo '-------------------------------------------------------'
	cat $TempFile2 | $CAWK -F ' ' '
	{
	   freesize=prtnum($2*'$pagesize');
		fullfree=prtnum($5);

   	if ( $3 <= $4 )
      	printf("[41;33m%-19s      %11d   %16s  [ %10s (%d) ][0m\n", $1, $3, freesize, fullfree, $4);
   	else
      	printf("%-19s      %11d   %16s  [ [32m%10s[0m ([33m%d[0m) ]\n", $1, $3, freesize, fullfree, $4);
	
	}
	function prtnum ( num ) {
	   result="";
		orgnum=num;
	   while ( int(num / 1000 * 1000) > 0 )
	   {
	      temp=result;
	      if ( num - int(num / 1000) * 1000 == 0 && int(num / 1000) > 0)
	         result="000";
	      else if ( num - int(num / 1000) * 1000 < 10 && int(num / 1000) > 0)
	         result="00"(num - int(num / 1000) * 1000);
	      else if ( num - int(num / 1000) * 1000 < 100 && int(num / 1000) > 0)
	         result="0"(num - int(num / 1000) * 1000);
	      else result=(num - int(num / 1000) * 1000);

	      if ( num != orgnum ) result = result","temp;
	      num = int(num / 1000);
	   }
	   if ( result == "" ) result=0;

		return result
	}
'

else

	echo 'Chunk ê°¯ìˆ˜ Check ì„¤ì •íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤'
	echo '$INFORMIXDIR/tool/etc/${INFORMIXSERVER}_chk.cnf íŒŒì¼ì—'
	echo 'í•„ìš”í•˜ì‹  ë‚´ìš©ì„ ì„¤ì •í•˜ì„¸ìš”'

fi

echo '-------------------------------------------------------'

#########################################################################
echo '[0m\c'

if [ -f $TempFile1 ]; then rm $TempFile1; fi
if [ -f $TempFile2 ]; then rm $TempFile2; fi
if [ -f $TempFile3 ]; then rm $TempFile3; fi
#########################################################################
