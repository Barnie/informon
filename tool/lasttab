#!/bin/ksh

#########################################################################
#
#   lasttab : ìµœê·¼ì— ìƒì„±ëœ Tableì„ ì°¾ëŠ” Shellì…ë‹ˆë‹¤
#
#
#   ì‚¬ìš©ë²• : lasttab [ëª‡ì¼ ì „ ê¹Œì§€ ì¡°íšŒì¸ì§€ ì…ë ¥] [DBëª…]
#            ì¡°íšŒ ê¸°ê°„ì„ ì…ë ¥í•˜ì§€ ì•Šì„ ê²½ìš° 7ì¼ë¡œ í•œë‹¤
#            DBëª…ì„ ì…ë ¥í•˜ì§€ ì•Šì„ ê²½ìš° dbnameìœ¼ë¡œ í•œë‹¤
#
#   í…Œì´ë¸” ë„¤ì´ë° ê·œì¹™ : í…Œì´ë¸”ëª…Prefix_YYYYMM
#
#########################################################################

# Tool í´ë” ì„¤ì • ########################################################
if [ ! "$TOOL" ]
then export TOOL=$HOME/tool
fi
#########################################################################


# OSë³„ awk ì„¤ì • #########################################################
if [ `uname` = 'HP-UX' ]
then
   export CAWK=awk
else
   export CAWK=nawk
fi
#########################################################################


# ì„ì‹œíŒŒì¼ ì´ˆê¸°í™” #######################################################
export TempTail=`tty | $CAWK -F/ '{print $4}'`
export TempFile1=$TOOL/tmp/`echo $0 | $CAWK -F '/' '{ print $NF }'`.tmp_${TempTail}

if [ -f $TempFile1 ]; then rm $TempFile1; fi
#########################################################################


# DBëª… ì„¤ì • #############################################################
if [ ! "$2" ]
then
	if [ ! "$DBNAME" ]
	then export dbname="dbname"
	else export dbname=$DBNAME
	fi
else export dbname=$2
fi
#########################################################################

echo '[0m\c'
################### Default #############################################


if [ ! "$1" ]
then export term=7
else export term=$1
fi

dbaccess $dbname <<! 1> /dev/null 2> /dev/null
set isolation to dirty read;
unload to $TempFile1 delimiter ' '
select {+ORDERED}
       distinct tabname, created, owner, fextsize, nextsize, dbinfo( "DBSPACE", p.pe_partnum )
  from systables t, sysmaster:sysptnext p
 where tabid > 99
   and tabtype='T'
   and created >= today - $term
   and p.pe_partnum = t.partnum
 order by created desc, tabname;
!

echo
echo '----------------------------------------------------------------------------------------'
echo '[5m                    Table Name     Created       Owner  FExtSize  NExtSize  Dbspace Name[0m'
echo '----------------------------------------------------------------------------------------'
cat $TempFile1 | $CAWK -F ' ' '{
{
	printf("%30s    %8s  %10s   %7d   %7d  %12s\n", $1, $2, $3, $4, $5, $6);
}
}'
echo '----------------------------------------------------------------------------------------'

if [ -f $TempFile1 ]; then rm $TempFile1; fi
