#!/bin/ksh

#########################################################################
#
#   locks : sysmaster DBì˜ syslocksë¥¼ ì¡°íšŒí•˜ì—¬
#           Sharedê°€ ì•„ë‹Œ Lockì´ ê±¸ë¦° Objectë“¤ì„ ë³´ì—¬ì£¼ëŠ” Shellì…ë‹ˆë‹¤
#
#   ì‚¬ìš©ë²• : locks [number of lines = 20]
#
#########################################################################

# Tool í´ë” ì„¤ì • ########################################################
if [ ! "$TOOL" ]
then export TOOL=$HOME/tool
fi
#########################################################################


# OSë³„ awk ì„¤ì • #########################################################
if [ `uname` = 'HP-UX' ]
then
   export CAWK=awk
else
   export CAWK=nawk
fi
#########################################################################

echo
echo 'DB Hang ìœ ë°œì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì™ ë§Œí•˜ë©´ ë‹¤ë¥¸ ë°©ë²•ì„ ì‚¬ìš©í•´ ë³´ì‹œì£ '
echo 'ê·¸ë˜ë„ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? \c'
read yn
if [ $yn != 'y' ]; then exit; fi

if [ ! "$1" ]
then export num=20
else export num=$1
fi

if [ -f $TOOL/tmp/lock0.unl ]; then rm $TOOL/tmp/lock0.unl
fi
if [ -f $TOOL/tmp/lock0.out ]; then rm $TOOL/tmp/lock0.out
fi

dbaccess sysmaster<<! 1> /dev/null 2> /dev/null
set isolation to dirty read;
unload to $TOOL/tmp/lock0.unl delimiter ' '
select first $num dbsname, tabname, MAX(type), sum(1) cnt from syslocks
 where type != 'S'
 group by dbsname, tabname;
!

if [ `cat $TOOL/tmp/lock0.unl | wc -l` -gt 0 ]
then

cat $TOOL/tmp/lock0.unl | $CAWK -F ' ' '{
{ printf("%-20s %-30s %9s %7d\n", $1, $2, $3, $4);}
}' >> $TOOL/tmp/lock0.out

echo '------------------------------------------'
echo 'Sharedê°€ ì•„ë‹Œ Lockì´ ê±¸ë¦° Objectë“¤ ì…ë‹ˆë‹¤.'
echo "---------------------------------------------------------------------"
echo "[5mDatabase Name        Object Name                         Type   Count[0m"
echo "---------------------------------------------------------------------"
cat $TOOL/tmp/lock0.out
echo "---------------------------------------------------------------------"
if [ `cat $TOOL/tmp/lock0.unl | wc -l` -eq $num ]
then echo "ë” ë§ì€ Lockì´ ì¡´ì¬í•˜ë¯€ë¡œ ê²€ìƒ‰ ë¼ì¸ ìˆ˜ë¥¼ ëŠ˜ë¦¬ì„¸ìš”"
fi

rm $TOOL/tmp/lock0.out

else

echo '--------------------------------------------'
echo 'Sharedê°€ ì•„ë‹Œ Lockì´ ê±¸ë¦° Objectê°€ ì—†ìŠµë‹ˆë‹¤.'
echo '--------------------------------------------'

fi

rm $TOOL/tmp/lock0.unl
