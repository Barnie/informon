#!/bin/ksh

#########################################################################
#
#   locktable0
#   : onstat -kë¥¼ ì¡°íšŒí•˜ì—¬, Lockì´ ê±¸ë¦° Objectë“¤ì„ ë³´ì—¬ì£¼ëŠ” Shellì…ë‹ˆë‹¤
#
#   ì‚¬ìš©ë²• : locktable0 (onstat -k file name )
#
#########################################################################

# Tool í´ë” ì„¤ì • ########################################################
if [ ! "$TOOL" ]
then export TOOL=$HOME/tool
fi
#########################################################################

if [ -f locktables.out ]; then rm locktables.out
fi
if [ -f $TOOL/tmp/locktable0.tmp ]; then rm $TOOL/tmp/locktable0.tmp
fi

if [ ! "$1" ]
then

echo 'ì‚¬ìš©ë²• : locktable0 ( onstat -k file name )'

else

echo "--------------------------------------------------------------------"

for i in `cat $1 | grep -v Informix | grep -v Locks | grep -v active | grep -v address |                   nawk -F ' ' '{
                   { if ( $3 == 0 ) print $6; }
                   }'`
do
echo 'Checking : '$i
dbaccess sysmaster<<! 1> /dev/null 2> /dev/null
set isolation to dirty read;
unload to $TOOL/tmp/locktable0.tmp delimiter ' '
select dbsname, tabname from systabnames
 where hex(partnum) = CASE
                      WHEN LENGTH('$i') = 6 THEN '0x00' || upper('$i')
                      WHEN LENGTH('$i') = 7 THEN '0x0'  || upper('$i')
                      WHEN LENGTH('$i') = 8 THEN '0x'   || upper('$i')
                      END;
!
cat $TOOL/tmp/locktable0.tmp | nawk -F ' ' '{
{ printf("%-20s %-40s\n", $1, $2);}
}' >> locktables.out
done

echo "--------------------------------------------------------------------"
echo "[5mDatabase Name[0m        [5mObject Name[0m"
echo "--------------------------------------------------------------------"
if [ -f locktables.out ]
then
cat locktables.out
else
echo 'Lock ê±¸ë¦° Objectê°€ ì—†ìŠµë‹ˆë‹¤.'
fi
echo "--------------------------------------------------------------------"

fi
