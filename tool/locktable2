#!/bin/ksh

#########################################################################
#
#   locktable2 : onstat -kì˜ ê²°ê³¼ë¡œ Lock ê±¸ë¦° Objectë¥¼ ë³´ì—¬ì£¼ëŠ” Shellì…ë‹ˆë‹¤
#
#   ì‚¬ìš©ë²• : locktable2 ( onstat -kì˜ ê²°ê³¼ë¥¼ ì €ì¥í•œ file name )
#   ìš”íŒŒì¼ : onstat -kì˜ ê²°ê³¼ë¥¼ ì €ì¥í•œ file
#
#########################################################################

# Tool í´ë” ì„¤ì • ########################################################
if [ ! "$TOOL" ]
then export TOOL=$HOME/tool
fi
#########################################################################


# OSë³„ awk ì„¤ì • #########################################################
if [ `uname` = 'HP-UX' ]
then
   export CAWK=awk
else
   export CAWK=nawk
fi
#########################################################################


# ì„ì‹œíŒŒì¼ ì´ˆê¸°í™” #######################################################
export TempTail=`tty | $CAWK -F/ '{print $4}'`
export TempFile1=$TOOL/tmp/`echo $0 | $CAWK -F '/' '{ print $NF }'`.tmp_${TempTail}
export TempFile2=$TOOL/tmp/`echo $0 | $CAWK -F '/' '{ print $NF }'`.tmp2_${TempTail}

if [ -f $TempFile1 ]; then rm $TempFile1; fi
if [ -f $TempFile2 ]; then rm $TempFile2; fi
#########################################################################


echo '[0m\c'
################### Default #############################################


if [ ! "$1" ]
then

	echo 'ì‚¬ìš©ë²• : locktable2 ( onstat -k file name )'

else

	for i in `cat $1 | grep -v Informix | grep -v Locks | grep -v active | grep -v address |
					$CAWK -F ' ' '{
										{ print $6; }
					}'`
	do
		export tblsnum="16#"$i
		typeset -i10 tblsnum

		echo 'o\c'
		dbaccess sysmaster<<! 1> /dev/null 2> /dev/null
			set isolation to dirty read;
			unload to $TempFile2 delimiter ' '
			select dbsname, tabname from systabnames
			 where partnum = '$tblsnum';
!
		cat $TempFile2 | $CAWK -F ' ' '{
			{ printf("%-20s %-40s\n", $1, $2);}
		}' >> $TempFile1
	done

	echo "\n--------------------------------------------------------------------"
	echo "[36;43mDatabase Name        Object Name                                    [0m"
	echo "--------------------------------------------------------------------"
	if [ -f $TempFile1 ]
	then
		cat $TempFile1
	else
		echo 'Lock ê±¸ë¦° Objectê°€ ì—†ìŠµë‹ˆë‹¤.'
	fi
	echo "--------------------------------------------------------------------"

	if [ -f $TempFile1 ]; then rm $TempFile1; fi
	if [ -f $TempFile2 ]; then rm $TempFile2; fi

fi
