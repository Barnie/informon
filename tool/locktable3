#!/bin/ksh

#########################################################################
#
#   locktable3 : íŠ¹ì • Tableì— Lockì„ ê±´ Session ì •ë³´ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤
#
#   ì‚¬ìš©ë²• : locktable3 (Tableëª…) [DBëª…]
#   ìš”íŒŒì¼ : chkpid, chksid
#
#########################################################################

# Tool í´ë” ì„¤ì • ########################################################
if [ ! "$TOOL" ]
then export TOOL=$HOME/tool
fi
#########################################################################


# OSë³„ awk ì„¤ì • #########################################################
if [ `uname` = 'HP-UX' ]
then
   export CAWK=awk
else
   export CAWK=nawk
fi
#########################################################################


# ì„ì‹œíŒŒì¼ ì´ˆê¸°í™” #######################################################
export TempTail=`tty | $CAWK -F/ '{print $4}'`
export TempFile1=$TOOL/tmp/`echo $0 | $CAWK -F '/' '{ print $NF }'`.tmp_${TempTail}

if [ -f $TempFile1 ]; then rm $TempFile1; fi
#########################################################################


# DBëª… ì„¤ì • #############################################################
if [ ! "$2" ]
then
	if [ ! "$DBNAME" ]
	then export dbname="dbname"
	else export dbname=$DBNAME
	fi
else export dbname=$2
fi
#########################################################################

echo '[0m\c'
################### Default #############################################

echo
echo 'DB Hang ìœ ë°œì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì™ ë§Œí•˜ë©´ ë‹¤ë¥¸ ë°©ë²•ì„ ì‚¬ìš©í•´ ë³´ì‹œì£ '
echo 'ê·¸ë˜ë„ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? \c'
read yn
if [ $yn != 'y' ]; then exit; fi

if [ ! "$1" ]
then

	echo 'ì‚¬ìš©ë²• : locktable3 tableëª… (DBëª…)'

else

	dbaccess sysmaster<<! 1> /dev/null 2> /dev/null
		set isolation to dirty read;
		unload to $TempFile1 delimiter ' '
		select {+ORDERED}
		       r.sid, max(r.username) username, count(*) locks
		  from ${DBNAME}:systables t, syslcktab l, systxptab x, sysrstcb r
		 where t.tabname = '$1'
		   and t.partnum = l.partnum
		   and l.owner = x.address
		   and x.owner = r.address
		 group by 1;
!

	echo '--------------------------------------------------------------------------'
	echo '[32;43mSession ID  User Name            nLocks      PID Process Name  TTY        [0m'
	echo '--------------------------------------------------------------------------'

	cat $TempFile1 | nawk -F ' ' '{
	{
		printf("%10d  %-18s  %7d  ", $1, $2, $3);
		system("chkpid $(chksid "$1")");
} }'

	echo '--------------------------------------------------------------------------'

	if [ -f $TempFile1 ]; then rm $TempFile1; fi

fi
