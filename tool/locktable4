#!/bin/ksh

#########################################################################
#
#   locktable4 : íŠ¹ì • Tableì— Lockì„ ê±´ Session ì •ë³´ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤
#
#
#   ì‚¬ìš©ë²• : locktable4 (Tableëª…) [DBëª…]
#   ìš”íŒŒì¼ : chklck, chkpid, chksid
#
#########################################################################

# Tool í´ë” ì„¤ì • ########################################################
if [ ! "$TOOL" ]
then export TOOL=$HOME/tool
fi
#########################################################################


# OSë³„ awk ì„¤ì • #########################################################
if [ `uname` = 'HP-UX' ]
then
   export CAWK=awk
else
   export CAWK=nawk
fi
#########################################################################


# DBëª… ì„¤ì • #############################################################
if [ ! "$2" ]
then
	if [ ! "$DBNAME" ]
	then export dbname="dbname"
	else export dbname=$DBNAME
	fi
else export dbname=$2
fi
#########################################################################


# ì„ì‹œíŒŒì¼ ì´ˆê¸°í™” #######################################################
export TempTail=`tty | $CAWK -F/ '{print $4}'`
export TempFile1=$TOOL/tmp/`echo $0 | $CAWK -F '/' '{ print $NF }'`.tmp_${TempTail}_$$
export TempFile2=$TOOL/tmp/`echo $0 | $CAWK -F '/' '{ print $NF }'`.tmp2_${TempTail}_$$

if [ -f $TempFile1 ]; then rm $TempFile1; fi
if [ -f $TempFile2 ]; then rm $TempFile2; fi
#########################################################################

printf '[0m'
################### Default #############################################

echo 

if [ ! "$1" ]
then

	echo 'ì‚¬ìš©ë²• : locktable4 tableëª… (DBëª…)'

else

	export lckcnt=`chklck | grep '^Total' | $CAWK -F ' ' '{ print $2 }'`

	echo 'Lock ê°¯ìˆ˜ëŠ” '$lckcnt'ê°œ ì…ë‹ˆë‹¤. ê·¸ë˜ë„ ìˆ˜í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? '

	echo
	read yn
	if [ $yn != 'y' ]; then exit; fi

	dbaccess sysmaster<<! 1> /dev/null 2> /dev/null
		set isolation to dirty read;
		unload to $TempFile1 delimiter ' '
		select lower(hex(partnum)) from systabnames where dbsname='$dbname' and tabname='$1';
!

	if [`cat $TempFile1 | wc -l` -eq 0 ]
	then
		echo 'ê·¸ëŸ° í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. DBëª…ê³¼ Tableëª…ì„ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•˜ì„¸ìš”.'
		exit
	fi

	export partnum=`cat $TempFile1 | $CAWK '{
   for (i=1; i<=length($1); i++) {
      if (substr($1, i, 1) != "0" && substr($1, i, 1) != "x") break;
   }
   print substr($1, i, length($1)-i+1);
}'`

	echo $dbname':'$1'ì˜ PartNum = '$partnum

	if [ -f $TempFile1 ]; then rm $TempFile1; fi	

	onstat -k | grep `echo $partnum` | $CAWK -F ' ' '{ print $3 }'> $TempFile1

	echo '---------------------------------------------------------------'
	echo '[32;43mSession ID   PID  Process Name  TTY                            [0m'
	echo '---------------------------------------------------------------'

	for i in `sort $TempFile1 | uniq`
	do
		dbaccess sysmaster<<! 1> /dev/null 2> /dev/null
			set isolation to dirty read;
			unload to $TempFile2 delimiter ' '
			select sid from sysrstcb where address='0x$i'::int8;
!

		cat $TempFile2 | $CAWK -F ' ' '{
			printf("%10d  ", $1);
			system("chkpid $(chksid "$1")");
}'
		if [ -f $TempFile2 ]; then rm $TempFile2; fi	
	done

	echo '---------------------------------------------------------------'

	if [ -f $TempFile1 ]; then rm $TempFile1; fi

fi
