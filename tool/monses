#!/bin/ksh

####################################################################
# 
#   monses : Running ì¤‘ì¸ Sessionì˜ ì§€ì†ì‹œê°„ì„ Checkí•˜ëŠ” Shellì…ë‹ˆë‹¤
#
#   ì‚¬ìš©ë²• : monses [ì§€ì •ì‹œê°„(ì´ˆ) ì´ìƒ ì§€ì†ë˜ëŠ” Sessionë§Œ í‘œì‹œ]
#            ì§€ì •ì‹œê°„(ì´ˆ)ì„ ì…ë ¥í•˜ì§€ ì•Šì„ ê²½ìš° 0ì´ˆë¡œ í•œë‹¤
#
####################################################################

export TOOL=$HOME/tool

if [ ! "$1" ]
then export min=0
else export min=$1
fi

if [ -f $TOOL/tmp/monses.tmp ]; then rm $TOOL/tmp/monses.tmp; fi
if [ -f $TOOL/tmp/monses2.tmp ]; then rm $TOOL/tmp/monses2.tmp; fi
if [ -f $TOOL/tmp/monses3.tmp ]; then rm $TOOL/tmp/monses3.tmp; fi

onstat -u | egrep -v P--D | egrep -v P--F | egrep -v P--B | egrep -v Y--P | egrep -v '\-\-\-P---' | egrep -v active | egrep -v Userthreads | egrep -v Server | egrep -v sessid | nawk -F ' ' '{
{ print $3; }
}' > $TOOL/tmp/monses2.tmp

/usr/bin/echo '1,$g/^$/d\nw\nq' | ed $TOOL/tmp/monses2.tmp > /dev/null
/usr/bin/echo '1,$s/$/ 0 '`date +%Y%m%d-%H:%M:%S`'/g\nw\nq' | ed $TOOL/tmp/monses2.tmp > /dev/null

while true
do

	touch $TOOL/tmp/monses2.tmp
	touch $TOOL/tmp/monses3.tmp

	onstat -u | egrep -v P--D | egrep -v P--F | egrep -v P--B | egrep -v Y--P | egrep -v '\-\-\-P---' | egrep -v active | egrep -v Userthreads | egrep -v Server | egrep -v sessid | nawk -F ' ' '{
	{ print $3; }
	}' > $TOOL/tmp/monses.tmp

	/usr/bin/echo '1,$g/^$/d\nw\nq' | ed $TOOL/tmp/monses.tmp > /dev/null

	for i in `cat $TOOL/tmp/monses.tmp`
	do

		if [ `grep ^$i $TOOL/tmp/monses2.tmp | wc -l` -eq 0 ] 
		then

		  if [ `grep ^$i $TOOL/tmp/monses3.tmp | wc -l` -eq 0 ]; then
		    echo $i' 0 '`date +%Y%m%d-%H:%M:%S` >> $TOOL/tmp/monses3.tmp
		  fi

		else

 	 		if [ `grep ^$i $TOOL/tmp/monses3.tmp | wc -l` -eq 0 ]; then
	    		grep ^$i $TOOL/tmp/monses2.tmp | head -1 | nawk -F ' ' '{
			   { printf("%d %d %s\n", $1, $2+1, $3); }
    			}' >> $TOOL/tmp/monses3.tmp
  			fi

		fi
	done

	clear
	echo '-----------------------------------------'
	echo '[5mSession ID    Duration  Start Time       [0m'
	echo '-----------------------------------------'
	cat $TOOL/tmp/monses3.tmp | nawk -F ' ' '{
	{ if ( $2 >= '$min' ) printf("%10d  %10d  %s\n", $1, $2, $3); }
	}'
	echo '-----------------------------------------'
	print ' Active Session Count          '`cat $TOOL/tmp/monses3.tmp | wc -l` 
	echo ' Current Time           '`date +%Y%m%d-%H:%M:%S` 
	echo '-----------------------------------------'
	echo 'ì´ Shellë„ Systemì— ì¼ì •ë¶€ë¶„ ë¶€í•˜ë¥¼ ì£¼ë‹ˆ'
	echo 'ê¼­ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì‚¬ìš©í•˜ì„¸ìš”'
	cp $TOOL/tmp/monses3.tmp $TOOL/tmp/monses2.tmp

	if [ -f $TOOL/tmp/monses3.tmp ]; then rm $TOOL/tmp/monses3.tmp; fi

	sleep 1

done
